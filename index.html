<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelacakan Tangki BBM Truk</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            margin-top: 20px;
        }
        #dataTable {
            margin-top: 20px;
        }
        #cameraStream {
            width: 100%;
            height: 300px;
            border: 1px solid black;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Tracking Truk dan BBM</h2>
        <div id="dateInfo" class="mb-2"></div>
        <div id="locationInfo">Menunggu lokasi...</div>
        <div id="distanceInfo">Jarak Ditempuh: 0 km</div>
        <div id="speedInfo">Kecepatan: 0 km/jam</div>
        <div id="fuelInfo">Konsumsi BBM: 0 liter</div>
        <button id="startTracking" class="btn btn-secondary mt-2" onclick="startTracking()">Mulai Lacak Lokasi</button>
        <button id="stopTracking" class="btn btn-danger mt-2" onclick="stopTracking()">Hentikan Lacak Lokasi</button>
        <button id="clearData" class="btn btn-warning mt-2" onclick="clearData()">Hapus Data</button>
        
        <div id="map"></div>
        <br>
        <video id="cameraStream" autoplay playsinline></video>
        <button id="captureSnapshot" class="btn btn-primary mt-2">Ambil Snapshot</button>
        <br>
        <table id="dataTable" class="table table-bordered table-hover mt-4">
            <thead class="thead-dark">
                <tr>
                    <th>Waktu</th>
                    <th>Kecepatan (km/jam)</th>
                    <th>Jarak Tempuh (km)</th>
                    <th>Konsumsi BBM (liter)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script>
        // Mengatur Date & Day
        function displayDateInfo() {
            const dateInfo = document.getElementById('dateInfo');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const currentDate = new Date().toLocaleDateString('id-ID', options);
            dateInfo.textContent = `Hari ini: ${currentDate}`;
        }

        displayDateInfo();
        $(document).ready(function() {
            $('#dataTable').DataTable();
        });

        // Lokasi dan Pelacakan
        let watchId;
        let lastPosition = null;
        let totalDistance = 0;
        let totalFuelConsumed = 0;
        let map, marker, saveDataInterval, updateTableInterval;

        // Fungsi Kamera
        const video = document.getElementById('cameraStream');
        const startCamera = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (err) {
                console.error("Kesalahan akses kamera:", err);
            }
        };

        document.getElementById('captureSnapshot').addEventListener('click', () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/png');
            let snapshots = JSON.parse(localStorage.getItem('cameraSnapshots')) || [];
            snapshots.push(imageData);
            localStorage.setItem('cameraSnapshots', JSON.stringify(snapshots));
            alert('Snapshot berhasil diambil dan disimpan di localStorage.');
        });

        startCamera();

        // Fungsi Perekaman Suara
        let mediaRecorder;
        let chunks = [];

        const startRecording = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (event) => {
                    chunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(chunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        let recordings = JSON.parse(localStorage.getItem('audioRecordings')) || [];
                        recordings.push(reader.result);
                        localStorage.setItem('audioRecordings', JSON.stringify(recordings));
                        chunks = [];
                    };
                };
                mediaRecorder.start();
            } catch (err) {
                console.error("Kesalahan akses mikrofon:", err);
            }
        };

        const stopRecording = () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        };

        // Tambahkan pemanggilan fungsi perekaman saat pelacakan dimulai
        function startTracking() {
            startRecording();
            if (navigator.geolocation) {
                map = L.map('map').setView([0, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap'
                }).addTo(map);

                watchId = navigator.geolocation.watchPosition(updateLocation, console.error, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                });

                saveDataInterval = setInterval(saveDataAutomatically, 60000);
                updateTableInterval = setInterval(displayDataInTable, 45000);
            } else {
                alert("Geolocation tidak didukung oleh browser ini.");
            }
        }

        function stopTracking() {
            stopRecording();
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        }
    </script>
</body>
</html>
